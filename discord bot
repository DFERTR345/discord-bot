import nextcord
import asyncio
from nextcord.ext import commands, tasks
import qrcode  # QR ì½”ë“œ ìƒì„±ì— ì‚¬ìš©ë˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
from datetime import datetime
import os


# ì¸í…íŠ¸ ì„¤ì •
intents = nextcord.Intents.default()
intents.messages = True
intents.guilds = True
intents.voice_states = True
intents.message_content = True
intents.reactions = True

# ë´‡ ê°ì²´ ìƒì„±
bot = commands.Bot(intents=intents)

# ë¡œê·¸ ì±„ë„ IDë¥¼ ì§€ì •
log_channel_id = 1230798189381160982  # ë¡œê·¸ ì±„ë„ ID (ì •ìˆ˜ë¡œ ë³€ê²½)

# ë©”ì‹œì§€ ë³´ë‚´ëŠ” ì±„ë„ IDë¥¼ ì§€ì •
send_channel_id = 1230425877762936913  # 2ì‹œê°„ë§ˆë‹¤ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ì±„ë„ ID (ì •ìˆ˜ë¡œ ë³€ê²½)

# ë©˜ì…˜í•  ì—­í• ì˜ IDë¥¼ ì§€ì •
role_id = 1230463819604693045  # ë©˜ì…˜í•  ì—­í• ì˜ ID (ì •ìˆ˜ë¡œ ë³€ê²½)

# ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™”ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
@bot.event
async def on_ready():
    print(f'ë´‡ì´ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤: {bot.user.name}')
    
    # ë´‡ì˜ ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    await bot.change_presence(
        status=nextcord.Status.online,
        activity=nextcord.Activity(
            type=nextcord.ActivityType.playing,
            name='ì•ˆë…•í•˜ì„¸ìš”! KRë´‡ì…ë‹ˆë‹¤.'
        )
    )
    
    await bot.change_presence(status=nextcord.Status.online, activity=nextcord.Game(name="KRë´‡ ê´€ë¦¬ì¤‘ https://discord.gg/urFjtKmqdn KRì„œë²„ ë“¤ì–´ì˜¤ê¸°"))

        # ì‚¬ìš©ì ì§€ì • ìƒíƒœ ì„¤ì •ë²•
        # status=nextcord.Status.online      (ì˜¨ë¼ì¸)
        # status=nextcord.Status.idle        (ìë¦¬ ë¹„ì›€)
        # status=nextcord.Status.dnd         (ë‹¤ë¥¸ ìš©ë¬´)
        # status=nextcord.Status.offline     (ì˜¤í”„ë¼ì¸)
        #
        #   ~~í•˜ëŠ” ì¤‘ ë“± ìƒíƒœ ì„¤ì •ë²•
        # activity=nextcord.Game(name="í•˜ëŠ” ì¤‘")
        # activity=nextcord.Streaming(name="ë°©ì†¡ ì¤‘", url="ì˜¬ë¦¬ê³  ì‹¶ì€ URL")
        # activity=nextcord.Activity(type=nextcord.ActivityType.listening, name="ë“£ëŠ” ì¤‘")
        # activity=nextcord.Activity(type=nextcord.ActivityType.watching, name="ì‹œì²­ ì¤‘")

    # ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™”ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    try:
        await bot.tree.sync()
        print("ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™” ì™„ë£Œ")
    except Exception as e:
        print(f"ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

    # 2ì‹œê°„ë§ˆë‹¤ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.
    send_periodic_message.start()

# 2ì‹œê°„ë§ˆë‹¤ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.
@tasks.loop(hours=2)
async def send_periodic_message():
    # ì±„ë„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    channel = bot.get_channel(send_channel_id)
    if channel:
        # ë©˜ì…˜í•  ì—­í• ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        guild = channel.guild
        role = guild.get_role(role_id)
        
        # ì„ë² ë“œ ë©”ì‹œì§€ ì‘ì„±
        embed = nextcord.Embed(
            title="ì•ˆë…•í•˜ì„¸ìš”!",
            description=(
                f"{role.mention if role else ''}\n"
                "1. '/up'ì„ ì‚¬ìš©í•˜ì—¬ ì„œë²„ë¥¼ upí•˜ê±°ë‚˜\n"
                "2. '/ì¶”ì²œ'ì„ ì‚¬ìš©í•˜ì—¬ ì„œë²„ë¥¼ ì‚¬ì´íŠ¸ì— ì¶”ì²œí•˜ì„¸ìš”!\n\n"
                "(/up ëª…ë ¹ì–´ëŠ” ë‘ ì‹œê°„ë§ˆë‹¤ ê°€ëŠ¥í•˜ë©° /ì¶”ì²œ ëª…ë ¹ì–´ëŠ” ë§¤ì¼ í•œ ë²ˆì”© ê°€ëŠ¥í•©ë‹ˆë‹¤.)"
            ),
            color=nextcord.Color.green()
        )
        
        # ë©”ì‹œì§€ ì „ì†¡
        await channel.send(embed=embed)
    else:
        print("ì§€ì •ëœ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

# ë©”ì‹œì§€ ì‚­ì œ ì¶”ì 
@bot.event
async def on_message_delete(message):
    # ë¡œê·¸ ì±„ë„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    log_channel = bot.get_channel(log_channel_id)

    if not log_channel:
        print(f"ë¡œê·¸ ì±„ë„ ID '{log_channel_id}'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    embed = nextcord.Embed(
        title="ë©”ì‹œì§€ ì‚­ì œ",
        description=f"{message.author}ê°€ {message.channel} ì±„ë„ì—ì„œ ë©”ì‹œì§€ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.",
        color=nextcord.Color.red()
    )
    
    # ë©”ì‹œì§€ì˜ ë‚´ìš©ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€í•©ë‹ˆë‹¤.
    if message.content:
        embed.add_field(name="ë‚´ìš©", value=message.content, inline=False)

    if message.attachments:
        for attachment in message.attachments:
            embed.add_field(name="ì²¨ë¶€ íŒŒì¼ ì‚­ì œë¨", value=f"[{attachment.filename}]({attachment.url})", inline=False)

    await log_channel.send(embed=embed)

# ì„œë²„ ìˆ˜ ë°˜í™˜ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ
@bot.slash_command(name="ì„œë²„ê°¯ìˆ˜", description="ë´‡ì´ ê°€ì…í•œ ì„œë²„ì˜ ìˆ˜ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.")
async def server_count_command(interaction: nextcord.Interaction):
    # ë´‡ì´ ê°€ì…í•œ ì„œë²„ ìˆ˜ ê³„ì‚°
    server_count = len(bot.guilds)
    
    # ì„œë²„ ìˆ˜ë¥¼ í¬í•¨í•œ ì‘ë‹µ ë©”ì‹œì§€ ìƒì„±
    response_message = f'ë´‡ì´ ê°€ì…í•œ ì„œë²„ ìˆ˜: {server_count}'
    
    # ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ì‘ë‹µ
    await interaction.response.send_message(response_message)

# íì•Œìƒì„± ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ì¶”ê°€
@bot.slash_command(name="íì•Œìƒì„±", description="ì…ë ¥í•œ ë§í¬ì— ëŒ€í•œ QR ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")
async def qr_create_command(interaction: nextcord.Interaction, link: str):
    # ì…ë ¥ëœ URLì— ëŒ€í•œ QR ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_L,
        box_size=10,
        border=4,
    )
    qr.add_data(link)
    qr.make(fit=True)

    # QR ì½”ë“œë¥¼ ì´ë¯¸ì§€ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    img = qr.make_image(fill_color="black", back_color="white")

    # ì´ë¯¸ì§€ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
    # ì´ë¯¸ì§€ íŒŒì¼ì„ ì¼ì‹œì ìœ¼ë¡œ ì €ì¥í•˜ì—¬ ì‘ë‹µì— ì‚¬ìš©í•©ë‹ˆë‹¤.
    img_path = f"qr_code_{datetime.now().strftime('%Y%m%d%H%M%S')}.png"
    img.save(img_path)

    # ìƒì„±ëœ QR ì½”ë“œë¥¼ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©ìì—ê²Œ ì „ì†¡í•©ë‹ˆë‹¤.
    await interaction.response.send_message(file=nextcord.File(img_path))
    
    # ì´ë¯¸ì§€ íŒŒì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤ (ì¼ì‹œì ì¸ íŒŒì¼ì´ë¯€ë¡œ)
    os.remove(img_path)

# í•‘ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ì¶”ê°€
@bot.slash_command(name="í•‘", description="ë´‡ì˜ í•‘ì„ í™•ì¸í•©ë‹ˆë‹¤.")
async def ping_command(interaction: nextcord.Interaction):
    # ë´‡ì˜ í•‘ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    bot_ping = round(bot.latency * 1000)  # ë°€ë¦¬ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ì—¬ í•‘ì„ ê³„ì‚°í•©ë‹ˆë‹¤.

    # ì„ë² ë“œ ë©”ì‹œì§€ ì‘ì„±
    embed = nextcord.Embed(
        title=" íì´ì—ìš”!",
        description=f"KRë´‡ì˜ í•‘: {bot_ping}ms",
        color=nextcord.Color.blue()
    )

    # ë´‡ì˜ ì´ë¯¸ì§€ë¥¼ ì„ë² ë“œì— ì¶”ê°€í•©ë‹ˆë‹¤.
    embed.set_thumbnail(url=bot.user.avatar.url)

    # 'í˜„ì¬ ë´‡ì˜ í•‘ì…ë‹ˆë‹¤.' ë¬¸êµ¬ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    embed.set_footer(text="í˜„ì¬ ë´‡ì˜ í•‘ì…ë‹ˆë‹¤.")

    # ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ì‘ë‹µ
    await interaction.response.send_message(embed=embed)

# ê¸°ê¸°í™•ì¸ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ì¶”ê°€
@bot.slash_command(name="ê¸°ê¸°í™•ì¸", description="í˜„ì¬ ì ‘ì† ê¸°ê¸°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.")
async def device_check_command(interaction: nextcord.Interaction):
    # ê¸°ê¸°ë³„ ì ‘ì†ì ìˆ˜ë¥¼ ì €ì¥í•  ë”•ì…”ë„ˆë¦¬
    device_count = {"ìŠ¤ë§ˆíŠ¸í°": 0, "ì»´í“¨í„°": 0}

    # ì„œë²„ì˜ ëª¨ë“  ë©¤ë²„ì— ëŒ€í•´ ë°˜ë³µí•˜ì—¬ ê¸°ê¸° í™•ì¸
    for member in interaction.guild.members:
        # ì‚¬ìš©ìì˜ presenceë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        await member.fetch()
        
        # ì‚¬ìš©ìì˜ presenceê°€ Noneì´ ì•„ë‹ˆë¼ë©´
        if member.raw_status != 'offline':
            # ì‚¬ìš©ìê°€ ì–´ë–¤ ê¸°ê¸°ë¡œ ì ‘ì†í–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            for activity in member.activities:
                if isinstance(activity, nextcord.Spotify) or isinstance(activity, nextcord.Streaming):
                    device_count["ìŠ¤ë§ˆíŠ¸í°"] += 1
                elif isinstance(activity, nextcord.CustomActivity) and activity.platform == 'desktop':
                    device_count["ì»´í“¨í„°"] += 1

    # ì„ë² ë“œ ë©”ì‹œì§€ ì‘ì„±
    embed = nextcord.Embed(
        title="ê¸°ê¸° í™•ì¸",
        description=f"{interaction.author.mention}ë‹˜ì˜ ë””ìŠ¤ì½”ë“œ ì ‘ì† ê¸°ê¸° ({sum(device_count.values())}ê°œ)",
        color=nextcord.Color.gold()
    )

    # ê° ê¸°ê¸°ë³„ ì ‘ì† ìƒíƒœë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    for device, count in device_count.items():
        # ê¸°ê¸°ì— ë”°ë¼ ì•„ì´ì½˜ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        icon = "ğŸŸ¢" if count > 0 else "ğŸŸ¡"
        embed.add_field(name=f"{device} {icon}", value=f"{count}ê°œ", inline=True)

    # ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ì‘ë‹µ
    await interaction.response.send_message(embed=embed)
    

# ë´‡ ì‹¤í–‰
bot.run("MTIzMDQ0NDczMjg1Mzc4NDU5Nw.GUeX_e.hjS11ymvzYnVPJtDKdsZlp2xBUJneUtAO4b6Do")


